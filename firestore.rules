rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper functions to check user roles based on custom claims
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }

    function isStaff() {
      return isAuthenticated() && (request.auth.token.role == 'admin' || request.auth.token.role == 'staff');
    }

    // --- User-specific data and roles ---
    // The 'users' collection stores custom user data like roles.
    match /users/{userId} {
      // Authenticated users can read their own user document (to get their role)
      allow read: isAuthenticated();
      // Only admins can create, update, or delete user roles/data
      allow write: isAdmin();
    }

    // --- Customer Management ---
    match /customers/{customerId} {
      // All authenticated users can read customer data
      allow read: isAuthenticated();
      // Only Admins and Staff can create, update, or delete customer data
      allow write: isStaff();
    }

    // --- Product Management ---
    match /products/{productId} {
      // All authenticated users can read product data
      allow read: isAuthenticated();
      // Only Admins and Staff can create, update, or delete product data
      allow write: isStaff();
    }

    // --- Order Management ---
    match /orders/{orderId} {
      // All authenticated users can read order data
      allow read: isAuthenticated();
      // Only Admins and Staff can create, update, or delete order data
      allow write: isStaff();
    }

    // --- Materials Management ---
    match /materials/{materialId} {
      // All authenticated users can read material data
      allow read: isAuthenticated();
      // Only Admins and Staff can create, update, or delete material data
      allow write: isStaff();
    }

    // --- Expenses Management ---
    match /expenses/{expenseId} {
      // Only Admins and Staff can read, create, update, or delete expense data
      allow read, write: isStaff();
    }

    // --- Settings & Customization ---
    match /settings/{settingId} {
      // All authenticated users can read settings (e.g., language)
      allow read: isAuthenticated();
      // Only Admins can create, update, or delete settings
      allow write: isAdmin();
    }

    // --- Deny access to any other un-matched collections ---
    match /{document=**} {
      allow read, write: false;
    }
  }
}